# **KnowledgePlus MVP開発リファクタリング指示書**

## **1\. プロジェクト概要**

### **1.1. 最終目標**

本プロジェクトの最終目標は、アップロードされた社内文書やナレッジを基に、高精度な検索と対話を実現するSaaS「KnowledgePlus」を構築し、Google Cloud上で展開することである。

### **1.2. MVPの定義**

ローカル環境で動作する、主要機能（検索・チャット）のコアな価値を体験できる最小限のプロダクト（MVP）を構築する。このMVPは、優れたUI/UXを備え、実際のユーザーによる評価に耐えうる品質を持つものとする。

### **1.3. 基本設計思想**

* **UI/UX第一主義**: 全ての機能は、Google検索のように「シンプルで、直感的で、分かりやすい」インターフェースを通じて提供される。  
* **モジュール化**: 機能ごとにコンポーネントを疎結合に保ち、将来の仕様変更や機能追加、クラウド移行に柔軟に対応できる設計とする。  
* **段階的開発**: フェーズごとに明確なゴールを設定し、テストとレビューを繰り返しながら着実に開発を進める。

## **2\. 開発フェーズとタスク**

### **フェーズ 0: 基盤整備と環境構築**

**目的:** リファクタリングを開始するための土台を整える。既存の優れたロジックを維持しつつ、今後の開発に備えてプロジェクト構造を整理する。

| タスクID | タスク内容 | 対象ファイル/ディレクトリ | 備考 |
| :---- | :---- | :---- | :---- |
| **0-1** | **requirements.txt の統合** | requirements.txt, knowledge\_gpt\_app/requirements.txt, mm\_kb\_builder/requirements.txt | 全ての依存関係をプロジェクトルートのrequirements.txtに集約し、重複を削除する。OpenAIの最新ライブラリ (openai\>=1.0) を含めること。 |
| **0-2** | **設定情報の一元管理** | config.py | OpenAI APIキーやモデル名、ナレッジベースのパスなど、プロジェクト全体で使用する設定値をこのファイルで一元管理する。 |
| **0-3** | **バックエンドロジックの整理** | shared/, knowledge\_gpt\_app/, mm\_kb\_builder/ | ui\_design\_plan.mdの設計に基づき、knowledge\_gpt\_appとmm\_kb\_builder内のビジネスロジックをsharedディレクトリ内の各クラス（KnowledgeBuilder, HybridSearchEngine, ChatController等）に整理・統合する。この時点ではUIの変更は行わない。 |
| **0-4** | **メインファイルの準備** | unified\_app.py | このファイルをリファクタリングのベースとする。他のapp.pyはアーカイブする。 |

**✅ フェーズ0完了の確認項目:**

* \[ \] pip install \-r requirements.txt で環境が構築できること。  
* \[ \] config.py に設定が集約されていること。  
* \[ \] shared ディレクトリに主要なロジックがクラスとして整理されていること。

### **フェーズ 1: UI/UXの全面刷新と「検索」機能の実装**

**目的:** アプリケーションの「顔」となるUIを刷新し、中核機能である「ナレッジ検索」を最高のUXで提供する。

| タスクID | タスク内容 | 対象ファイル/ディレクトリ | 具体的な指示 |
| :---- | :---- | :---- | :---- |
| **1-1** | **全体テーマの適用** | unified\_app.py, ui\_modules/theme.py | st.set\_page\_config を使用し、ページタイトルを「ナレッジ+」に設定。ui\_modules/theme.py の apply\_intel\_theme を適用し、アプリ全体の配色とフォントを統一する。 |
| **1-2** | **検索中心レイアウトの構築** | unified\_app.py | 1\. 画面上部に st.title("ナレッジ+") を配置。 2\. st.markdown を使用してカスタムCSSを適用し、メインコンテンツエリアを中央揃え、最大幅850pxに制限する。 3\. st.text\_input を配置。placeholderは「キーワードで検索、またはAIへの質問を入力...」とする。角丸でモダンなスタイルをCSSで適用すること。 4\. st.button("検索") を配置。ui\_design\_plan.md に従い、青い背景に白いテキストの角丸ボタンとしてスタイリングする。 |
| **1-3** | **検索結果表示UIの実装** | unified\_app.py | 1\. 検索実行後、st.tabs を使用して \["AIによる要約", "関連ナレッジ一覧"\] の2つのタブを表示する。 2\. 「関連ナレッジ一覧」タブ内に、検索結果をカード形式で表示する。各カードは st.container と with st.container(border=True): を使って作成し、ファイル名のアイコン(例: 📄)、ファイル名、内容のスニペットを表示する。 |
| **1-4** | **検索ロジックの接続** | unified\_app.py, shared/search\_engine.py | 検索ボタンが押されたら、shared/search\_engine.py の HybridSearchEngine クラスを呼び出し、検索を実行。結果を st.session\_state に保存し、結果表示UIに渡す。検索中は st.spinner("検索中...") を表示する。 |

**✅ フェーズ1完了の確認項目:**

* \[ \] UIがデザイン案通りに刷新され、全てのテキストが日本語化されていること。  
* \[ \] 検索ボックスとボタンが中央に配置され、スタイリングが適用されていること。  
* \[ \] 検索を実行すると、スピナーが表示され、結果がカード形式でタブ内に正しく表示されること。  
* \[ \] レスポンシブデザインであり、PC・スマートフォンの両方でレイアウトが崩れないこと。

### **フェーズ 2: 高機能チャット（AIエージェント）とストリーミングの実装**

**目的:** 対話体験を向上させるため、AIエージェント選択機能と、応答のストリーミング表示を実装する。

| タスクID | タスク内容 | 対象ファイル/ディレクトリ | 具体的な指示 |
| :---- | :---- | :---- | :---- |
| **2-1** | **チャットUIの構築** | unified\_app.py | 1\. サイドバー (st.sidebar) を作成し、st.radio で \["検索", "チャット"\] のモード選択を配置する。 2\. 「チャット」モード選択時、メイン画面にチャット履歴表示エリアと入力ボックス (st.chat\_input) を表示する。 3\. st.session\_state を活用し、チャット履歴を保持・表示する。st.chat\_message を使用し、ユーザーとAIの発言を区別して表示する。 |
| **2-2** | **AIエージェント選択機能** | unified\_app.py, knowledge\_gpt\_app/data/personalities/ | 1\. チャットモードのサイドバーに st.selectbox を配置し、「AIエージェントを選択」というラベルで、personalities ディレクトリ内のJSONファイル（expert, counselor等）をエージェントとして選択できるようにする。 2\. 選択されたエージェントのJSONからシステムプロンプトを読み込み、ChatController に渡す。 |
| **2-3** | **ストリーミング応答の実装** | shared/chat\_controller.py, unified\_app.py | 1\. shared/chat\_controller.py 内でOpenAI APIを呼び出す際、stream=True オプションを使用する。 2\. unified\_app.py 側で、st.write\_stream を使用して、コントローラーから返されるストリーミング応答をリアルタイムでチャット画面に描画する。 |

**✅ フェーズ2完了の確認項目:**

* \[ \] サイドバーで「検索」と「チャット」モードを切り替えられること。  
* \[ \] チャット画面で会話の履歴が正しく表示されること。  
* \[ \] サイドバーでAIエージェントを切り替えると、AIの応答スタイルが変わること。  
* \[ \] AIの応答が、タイプライターのように一文字ずつスムーズに表示（ストリーミング）されること。

### **フェーズ 3: ナレッジ管理機能と仕上げ**

**目的:** ナレッジベースを管理する機能を追加し、アプリケーション全体を完成させる。

| タスクID | タスク内容 | 対象ファイル/ディレクトリ | 具体的な指示 |
| :---- | :---- | :---- | :---- |
| **3-1** | **ファイルアップロード機能** | unified\_app.py, shared/kb\_builder.py | 1\. サイドバーに \["検索", "チャット", "ナレッジ管理"\] のモードを追加。 2\. 「ナレッジ管理」モード内に st.file\_uploader を設置し、複数のファイル（pdf, txt, docx）をアップロードできるようにする。 3\. アップロードされたファイルは shared/kb\_builder.py の KnowledgeBuilder に渡され、ナレッジベースに追加される。処理中は st.spinner を表示し、完了後は st.success でメッセージを表示する。 |
| **3-2** | **FAQ生成機能の統合** | unified\_app.py, generate\_faq.py | 1\. 「ナレッジ管理」モード内に「FAQを生成」ボタンを設置。 2\. ボタンが押されたら、generate\_faq.py のロジックを呼び出し、ナレッジベース全体からFAQを生成し、画面に表示する。 |
| **3-3** | **テストの拡充** | tests/ | pytest を使用し、shared ディレクトリに作成した各クラス（KnowledgeBuilder, HybridSearchEngine, ChatController）の単体テストを作成・拡充する。 |

**✅ フェーズ3完了の確認項目:**

* \[ \] ファイルをアップロードし、ナレッジベースを構築できること。  
* \[ \] 新しく追加したナレッジが、「検索」機能の対象となっていること。  
* \[ \] FAQ生成機能が動作すること。  
* \[ \] pytest ですべてのテストが成功すること。

### **フェーズ 4: クラウド移行準備**

**目的:** ローカルでのMVPを、Google Cloudへのデプロイが可能な状態にパッケージングする。

| タスクID | タスク内容 | 対象ファイル/ディレクトリ | 具体的な指示 |
| :---- | :---- | :---- | :---- |
| **4-1** | **Dockerfileの作成** | Dockerfile | アプリケーションを実行するためのDockerfileを作成する。Python環境のセットアップ、依存関係のインストール、アプリケーションの起動コマンド (streamlit run unified\_app.py) を記述する。 |
| **4-2** | **認証と状態管理の確認** | \- | Google Cloud IAPを利用した認証を想定し、Streamlitのst.user等の機能でユーザー情報を取得できるか確認する。現状のst.session\_stateによる状態管理は、SaaS化の際にはテナントごとに分離されたDB（Firestore等）に置き換える必要があることをドキュメントに明記する。 |
| **4-3** | **READMEの更新** | README.md | アプリケーションのセットアップ方法、実行方法、各機能の使い方、そしてクラウドへのデプロイ手順の概要を詳細に記述する。 |

**✅ フェーズ4完了の確認項目:**

* \[ \] docker build と docker run でアプリケーションが正常に起動すること。  
* \[ \] クラウド移行に向けた課題（認証、マルチテナント対応）が整理されていること。  
* \[ \] プロジェクトの全体像と使い方がREADME.mdを読めば理解できること。